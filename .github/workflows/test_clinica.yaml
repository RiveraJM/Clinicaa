name: CI Clinica

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

permissions:
  contents: read

env:
  COMPOSER_NO_INTERACTION: 1
  COMPOSER_PROCESS_TIMEOUT: 0
  COMPOSER_NO_AUDIT: 1

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    # -------------------------------------------------------
    # Checkout del repositorio usando HTTPS
    # -------------------------------------------------------
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # -------------------------------------------------------
    # Configurar PHP
    # -------------------------------------------------------
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo, pdo_mysql
        tools: phpunit
        coverage: none

    # -------------------------------------------------------
    # Validar composer.json si existe
    # -------------------------------------------------------
    - name: Validate composer.json
      run: |
        if [ -f composer.json ]; then
          composer validate --strict
        else
          echo "No composer.json found — skipping validate"
        fi

    # -------------------------------------------------------
    # Cache de Composer
    # -------------------------------------------------------
    - name: Cache Composer files
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    # -------------------------------------------------------
    # Instalar dependencias si existe composer.json
    # -------------------------------------------------------
    - name: Install Dependencies
      run: |
        if [ -f composer.json ]; then
          composer install --prefer-dist --no-interaction --no-progress
        else
          echo "No composer.json - skipping composer install"
        fi

    # -------------------------------------------------------
    # Instalar herramientas de análisis de código
    # -------------------------------------------------------
    - name: Install PHPStan
      run: |
        wget -q https://github.com/phpstan/phpstan/releases/latest/download/phpstan.phar -O phpstan
        chmod +x phpstan

    - name: Install PHPCS
      run: |
        composer global require squizlabs/php_codesniffer
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPMD
      run: |
        composer global require phpmd/phpmd
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPCPD
      run: |
        wget -q https://phar.phpunit.de/phpcpd.phar -O phpcpd
        chmod +x phpcpd

    # -------------------------------------------------------
    # Análisis de calidad de código
    # -------------------------------------------------------
    - name: PHPCS (PSR-12)
      run: phpcs --standard=PSR12 . || true

    - name: PHPStan (nivel máximo)
      run: ./phpstan analyse . --level=max --no-progress || true

    - name: PHPMD
      run: phpmd . text cleancode,codesize,design,unusedcode || true

    - name: PHPCPD
      run: ./phpcpd . || true 

    # -------------------------------------------------------
    # Ejecutar PHPUnit si existen tests
    # -------------------------------------------------------
    - name: Run PHPUnit
      run: |
        if [ -f vendor/bin/phpunit ]; then
          echo "Ejecutando PHPUnit..."
          vendor/bin/phpunit --colors=always || true
        else
          echo "PHPUnit no encontrado — no hay tests aún"
        fi
