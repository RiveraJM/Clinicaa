name: Test Clinica

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    # ðŸ‘‡ Entrar al directorio correcto (Clinica)
    - name: Enter project directory
      run: cd Clinica && pwd
      shell: bash

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, pdo, pdo_mysql
        tools: phpunit
        coverage: none

    - name: Validate composer.json
      run: cd Clinica && composer validate --strict

    - name: Cache Composer
      uses: actions/cache@v3
      with:
        path: Clinica/vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('Clinica/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: cd Clinica && composer install --prefer-dist --no-interaction --no-progress

    # -------------------------
    # Install Tools
    # -------------------------

    - name: Install PHPStan
      run: |
        cd Clinica
        wget -q https://github.com/phpstan/phpstan/releases/latest/download/phpstan.phar -O phpstan
        chmod +x phpstan

    - name: Install PHPCS
      run: |
        composer global require squizlabs/php_codesniffer
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPMD
      run: |
        composer global require phpmd/phpmd
        echo "${HOME}/.composer/vendor/bin" >> $GITHUB_PATH

    - name: Install PHPCPD
      run: |
        cd Clinica
        wget -q https://phar.phpunit.de/phpcpd.phar -O phpcpd
        chmod +x phpcpd

    # -------------------------
    # Code Quality Checks
    # -------------------------

    - name: Run PHPCS (PSR-12)
      run: phpcs --standard=PSR12 Clinica || true

    - name: Run PHPStan
      run: cd Clinica && ./phpstan analyse . --level=max --no-progress || true

    - name: Run PHPMD
      run: phpmd Clinica text cleancode,codesize,design,unusedcode || true

    - name: Run PHPCPD
      run: cd Clinica && ./phpcpd . || true

    - name: Run PHPUnit
      run: cd Clinica && vendor/bin/phpunit || true
